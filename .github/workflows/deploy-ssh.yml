# SSH-Deployment Workflow (Kostenlos - keine Credits)
# Aktiviert nach SSH-Zugang und GitHub Secrets Setup

name: Deploy via SSH (Kostenlos)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (build only)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

permissions:
  contents: read
  actions: read

jobs:
  build:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” TypeScript Check
        run: pnpm check

      - name: ðŸ—ï¸ Build Application
        run: |
          export NODE_ENV=production
          pnpm build

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  deploy:
    name: ðŸš€ Deploy via SSH (Kostenlos)
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name != 'pull_request' &&
      (github.event.inputs.skip_deploy != 'true' || github.event.inputs.skip_deploy == null)

    steps:
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ðŸ“‹ Get commit info
        id: commit
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "âœ… Deploying commit: $(git rev-parse --short HEAD)"

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ” Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "echo 'âœ… SSH connection successful'"

      - name: ðŸ“¦ Create deployment package
        run: |
          # Erstelle temporÃ¤res Verzeichnis fÃ¼r Deployment
          mkdir -p deploy-package
          cp -r dist/public/* deploy-package/
          
          # Erstelle Backup-Script
          cat > deploy-package/.deploy-info.txt << EOF
          Commit: ${{ steps.commit.outputs.sha_full }}
          Short SHA: ${{ steps.commit.outputs.sha_short }}
          Message: ${{ steps.commit.outputs.message }}
          Deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          echo "ðŸ“¦ Deployment package created"

      - name: ðŸš€ Deploy files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "deploy-package/*"
          target: "/var/www/houston.manus.space/dist"
          strip_components: 1
          rm: false  # LÃ¶sche alte Dateien nicht automatisch (Backup erstellen)

      - name: ðŸ”„ Create backup and cleanup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            
            DEPLOY_DIR="/var/www/houston.manus.space/dist"
            BACKUP_DIR="${DEPLOY_DIR}.backup.$(date +%s)"
            
            # Erstelle Backup falls Verzeichnis existiert
            if [ -d "$DEPLOY_DIR" ] && [ "$(ls -A $DEPLOY_DIR 2>/dev/null)" ]; then
              echo "ðŸ“¦ Creating backup: $BACKUP_DIR"
              sudo cp -r "$DEPLOY_DIR" "$BACKUP_DIR" || cp -r "$DEPLOY_DIR" "$BACKUP_DIR"
              echo "âœ… Backup created"
              
              # LÃ¶sche alte Backups (behalte nur die letzten 5)
              echo "ðŸ§¹ Cleaning up old backups..."
              ls -dt ${DEPLOY_DIR}.backup.* 2>/dev/null | tail -n +6 | xargs -r rm -rf || true
            fi
            
            # Stelle sicher, dass Berechtigungen korrekt sind
            echo "ðŸ” Setting permissions..."
            sudo chown -R www-data:www-data "$DEPLOY_DIR" 2>/dev/null || \
            sudo chown -R nginx:nginx "$DEPLOY_DIR" 2>/dev/null || \
            sudo chown -R $USER:$USER "$DEPLOY_DIR" 2>/dev/null || true
            
            sudo chmod -R 755 "$DEPLOY_DIR" || chmod -R 755 "$DEPLOY_DIR"
            
            echo "âœ… Deployment directory ready"

      - name: ðŸ”„ Restart server (if needed)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set +e  # Erlaube Fehler (Server-Restart ist optional)
            
            # PrÃ¼fe ob PM2 verwendet wird
            if command -v pm2 &> /dev/null; then
              echo "ðŸ”„ Restarting via PM2..."
              pm2 restart houston || pm2 restart all || echo "âš ï¸ PM2 restart skipped"
            fi
            
            # PrÃ¼fe ob systemd verwendet wird
            if systemctl list-units --type=service | grep -q houston; then
              echo "ðŸ”„ Restarting via systemd..."
              sudo systemctl restart houston || echo "âš ï¸ systemd restart skipped"
            fi
            
            # PrÃ¼fe ob Nginx neu geladen werden muss
            if command -v nginx &> /dev/null; then
              echo "ðŸ”„ Reloading Nginx..."
              sudo nginx -t && sudo systemctl reload nginx || echo "âš ï¸ Nginx reload skipped"
            fi
            
            echo "âœ… Server restart completed (or skipped)"

      - name: âœ… Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            DEPLOY_DIR="/var/www/houston.manus.space/dist"
            
            if [ -f "$DEPLOY_DIR/index.html" ]; then
              echo "âœ… Deployment verified: index.html exists"
              echo "ðŸ“„ File size: $(du -h $DEPLOY_DIR/index.html | cut -f1)"
              
              # Zeige Commit-Info falls vorhanden
              if [ -f "$DEPLOY_DIR/.deploy-info.txt" ]; then
                echo "ðŸ“‹ Deployment info:"
                cat "$DEPLOY_DIR/.deploy-info.txt"
              fi
            else
              echo "âš ï¸ Warning: index.html not found in $DEPLOY_DIR"
              exit 1
            fi

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ SSH Deployment (Kostenlos)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ steps.commit.outputs.sha_short }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Message | ${{ steps.commit.outputs.message }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | houston.manus.space |" >> $GITHUB_STEP_SUMMARY
          echo "| Method | SSH/SCP (kostenlos) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Keine Credits benÃ¶tigt!**" >> $GITHUB_STEP_SUMMARY
