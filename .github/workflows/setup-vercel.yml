# Vercel Setup - Programmatische Konfiguration

name: Setup Vercel

on:
  workflow_dispatch:
    inputs:
      setup_domain:
        description: 'Setup domain houston.manus.space'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'

permissions:
  contents: read

jobs:
  setup:
    name: ðŸš€ Setup Vercel
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: ðŸ” Login to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "::error::VERCEL_TOKEN secret is not set!"
            exit 1
          fi
          vercel login --token "$VERCEL_TOKEN"

      - name: ðŸ”— Link Project
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -n "$VERCEL_PROJECT_ID" ] && [ -n "$VERCEL_ORG_ID" ]; then
            echo "ðŸ”— Linking to existing project..."
            vercel link --yes --token "$VERCEL_TOKEN" --project "$VERCEL_PROJECT_ID" --scope "$VERCEL_ORG_ID" || true
          else
            echo "ðŸ“¦ Creating new project..."
            vercel link --yes --token "$VERCEL_TOKEN" || {
              echo "::warning::Project linking failed. Please link manually or set VERCEL_PROJECT_ID and VERCEL_ORG_ID secrets."
            }
          fi

      - name: ðŸŒ Add Domain
        if: github.event.inputs.setup_domain == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          DOMAIN="houston.manus.space"
          echo "ðŸŒ Adding domain: $DOMAIN"
          
          # PrÃ¼fe ob Domain bereits existiert
          if vercel domains ls --token "$VERCEL_TOKEN" 2>/dev/null | grep -q "$DOMAIN"; then
            echo "âœ… Domain $DOMAIN already exists"
          else
            echo "âž• Adding domain $DOMAIN..."
            vercel domains add "$DOMAIN" --token "$VERCEL_TOKEN" || {
              echo "::warning::Domain could not be added automatically. Please add it manually in Vercel Dashboard."
              echo "ðŸ’¡ Or configure DNS records first at Manus."
            }
          fi

      - name: ðŸ“‹ Show Domain Info
        if: github.event.inputs.setup_domain == 'true'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          DOMAIN="houston.manus.space"
          echo "ðŸ“‹ Domain information for $DOMAIN:"
          vercel domains inspect "$DOMAIN" --token "$VERCEL_TOKEN" || {
            echo "âš ï¸  Could not retrieve domain details. Domain may not be added yet."
          }

      - name: ðŸ“Š Setup Summary
        if: always()
        run: |
          echo "## ðŸš€ Vercel Setup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Vercel CLI installiert**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Login erfolgreich**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **NÃ¤chste Schritte:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Konfiguriere DNS-Records bei Manus" >> $GITHUB_STEP_SUMMARY
          echo "2. Warte auf DNS-Propagierung (5-60 Minuten)" >> $GITHUB_STEP_SUMMARY
          echo "3. PrÃ¼fe Domain-VerfÃ¼gbarkeit" >> $GITHUB_STEP_SUMMARY
