name: Optimized CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (build only)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“‹ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ðŸ—„ï¸ Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” TypeScript Check
        run: pnpm check

      - name: ðŸ§¹ Lint
        run: pnpm lint
        continue-on-error: true

      - name: ðŸ§ª Unit Tests
        run: pnpm test
        continue-on-error: true
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || '' }}

      - name: ðŸ—ï¸ Build Application
        run: pnpm build

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 7

      - name: ðŸ“Š Build Summary
        if: always()
        run: |
          echo "## ðŸ”¨ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** \`dist-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ðŸš€ Deploy to Manus
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name != 'pull_request' &&
      (github.event.inputs.skip_deploy != 'true' || github.event.inputs.skip_deploy == null)

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Letzte 2 Commits fÃ¼r Diff

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/

      - name: ðŸ“‹ Get commit info and changed files
        id: commit
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          
          # Liste geÃ¤nderter Dateien (nur relevante)
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E '\.(tsx?|json|css)$' | head -20 | tr '\n' ', ' || echo "")
          echo "changed_files=$CHANGED" >> $GITHUB_OUTPUT

      - name: ðŸš€ Trigger Manus Deployment
        id: deploy
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
        run: |
          if [ -z "$MANUS_API_KEY" ]; then
            echo "::error::MANUS_API_KEY secret is not set!"
            exit 1
          fi
          
          # Sehr prÃ¤ziser Prompt ohne RÃ¼ckfragen
          PROMPT="WICHTIG: FÃ¼hre diese Schritte AUTOMATISCH aus, ohne RÃ¼ckfragen!

          AUFGABE: Aktualisiere die Houston App auf houston.manus.space

          SCHRITT 1: Klone das Repository
          git clone https://github.com/cynarAI/Houston.git /home/ubuntu/houston-deploy
          cd /home/ubuntu/houston-deploy
          git checkout ${{ steps.commit.outputs.sha_full }}

          SCHRITT 2: Installiere Dependencies und baue die App
          pnpm install
          pnpm build

          SCHRITT 3: VerÃ¶ffentliche die App
          Verwende die Manus Publish-Funktion um die gebaute App auf houston.manus.space zu verÃ¶ffentlichen.

          WICHTIGE INFOS:
          - Commit: ${{ steps.commit.outputs.sha_short }}
          - GeÃ¤nderte Dateien: ${{ steps.commit.outputs.changed_files }}
          - Die App verwendet vite-plugin-manus-runtime
          - Keine RÃ¼ckfragen - einfach ausfÃ¼hren!"

          # Erstelle Task
          RESPONSE=$(curl -s -w "\n%{http_code}" --request POST \
            --url https://api.manus.ai/v1/tasks \
            --header "API_KEY: $MANUS_API_KEY" \
            --header "Content-Type: application/json" \
            --data "$(jq -n \
              --arg prompt "$PROMPT" \
              '{
                "prompt": $prompt,
                "agentProfile": "manus-1.5",
                "projectId": "9Ye7dFtLEUdP6ojxHpkQhu"
              }')")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Manus API request failed with status $HTTP_CODE"
            exit 1
          fi
          
          TASK_URL=$(echo "$BODY" | jq -r '.task_url // empty')
          TASK_ID=$(echo "$BODY" | jq -r '.task_id // empty')
          
          # Validierung: PrÃ¼fe ob Task-ID und URL vorhanden sind
          if [ -z "$TASK_ID" ] || [ -z "$TASK_URL" ]; then
            echo "::error::API response did not contain valid task_id or task_url"
            echo "Response body: $BODY"
            exit 1
          fi
          
          echo "task_url=$TASK_URL" >> $GITHUB_OUTPUT
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "âœ… Deployment task created: $TASK_URL"

      - name: â³ Wait and Monitor Task
        id: monitor
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
        run: |
          TASK_ID="${{ steps.deploy.outputs.task_id }}"
          
          # Validierung: PrÃ¼fe ob Task-ID vorhanden ist
          if [ -z "$TASK_ID" ]; then
            echo "::error::No task_id available from deploy step"
            exit 1
          fi
          
          MAX_WAIT=300  # 5 Minuten
          INTERVAL=30
          ELAPSED=0
          
          echo "â³ Monitoring task $TASK_ID..."
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            
            STATUS_RESPONSE=$(curl -s --request GET \
              --url "https://api.manus.ai/v1/tasks/$TASK_ID" \
              --header "API_KEY: $MANUS_API_KEY")
            
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status // "unknown"')
            echo "[$ELAPSED s] Task status: $STATUS"
            
            if [ "$STATUS" = "completed" ]; then
              echo "âœ… Task completed successfully!"
              echo "status=completed" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "failed" ] || [ "$STATUS" = "cancelled" ]; then
              echo "âŒ Task failed or cancelled"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            # Wenn Task auf Eingabe wartet, logge Warnung
            # Hinweis: Die Manus API hat keinen Endpoint zum Fortsetzen von Tasks.
            # Ein POST zu /v1/tasks wÃ¼rde einen NEUEN Task erstellen, nicht den bestehenden fortsetzen.
            if [ "$STATUS" = "pending" ]; then
              LAST_MSG=$(echo "$STATUS_RESPONSE" | jq -r '.output[-1].content[0].text // ""' | tail -c 500)
              if echo "$LAST_MSG" | grep -qi "frag\|information\|benÃ¶tige\|question\|authentif"; then
                echo "âš ï¸ Task wartet auf Eingabe und muss manuell fortgesetzt werden."
                echo "Task URL: ${{ steps.deploy.outputs.task_url }}"
                echo "Letzte Nachricht: $LAST_MSG"
              fi
            fi
          done
          
          echo "âš ï¸ Timeout reached, task still running"
          echo "status=timeout" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment to Manus" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ steps.commit.outputs.sha_short }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Message | ${{ steps.commit.outputs.message }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | houston.manus.space |" >> $GITHUB_STEP_SUMMARY
          echo "| Task URL | ${{ steps.deploy.outputs.task_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.monitor.outputs.status || 'triggered' }} |" >> $GITHUB_STEP_SUMMARY
