# Deployment via Manus Runtime API (OHNE Credits)
# Alternative zum Agent-basierten Deployment

name: Deploy via Manus Runtime API (DEAKTIVIERT)

on:
  # DEAKTIVIERT - Verwende stattdessen deploy-vercel.yml
  # push:
  #   branches: [main]
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (build only)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

permissions:
  contents: read
  actions: read

jobs:
  build:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” TypeScript Check
        run: pnpm check

      - name: ðŸ—ï¸ Build Application
        run: |
          export NODE_ENV=production
          pnpm build

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  deploy:
    name: ðŸš€ Deploy via Manus Runtime API (DEAKTIVIERT - Verwende Vercel)
    needs: build
    runs-on: ubuntu-latest
    if: false  # DEAKTIVIERT - API-Endpoint /v1/publish existiert nicht (HTTP 404)

    steps:
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ðŸ“‹ Get commit info
        id: commit
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "sha_full=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "âœ… Deploying commit: $(git rev-parse --short HEAD)"

      - name: ðŸš€ Deploy via Manus Runtime API
        env:
          MANUS_API_KEY: ${{ secrets.MANUS_API_KEY }}
        run: |
          if [ -z "$MANUS_API_KEY" ]; then
            echo "::error::MANUS_API_KEY secret is not set!"
            exit 1
          fi
          
          echo "ðŸš€ Deploying via Manus Runtime API..."
          echo "ðŸ“¦ Project ID: 9Ye7dFtLEUdP6ojxHpkQhu"
          echo "ðŸ“ Directory: dist/public"
          echo "ðŸŽ¯ Target: houston.manus.space"
          
          # PrÃ¼fe ob dist/public existiert
          if [ ! -d "dist/public" ]; then
            echo "::error::dist/public directory not found!"
            exit 1
          fi
          
          # API-Call
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST https://api.manus.ai/v1/publish \
            -H "API_KEY: $MANUS_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"project_id\": \"9Ye7dFtLEUdP6ojxHpkQhu\",
              \"directory\": \"dist/public\",
              \"target\": \"houston.manus.space\"
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Deployment erfolgreich!"
          elif [ "$HTTP_CODE" -eq 404 ]; then
            echo "::warning::API-Endpoint /v1/publish nicht gefunden. MÃ¶glicherweise nicht verfÃ¼gbar."
            echo "ðŸ’¡ Tipp: Verwende stattdessen SSH-Deployment oder Railway/Vercel."
            exit 1
          else
            echo "::error::Deployment fehlgeschlagen! HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Manus Runtime API Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ steps.commit.outputs.sha_short }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Message | ${{ steps.commit.outputs.message }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | houston.manus.space |" >> $GITHUB_STEP_SUMMARY
          echo "| Method | Manus Runtime API (keine Credits) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Keine Credits benÃ¶tigt!**" >> $GITHUB_STEP_SUMMARY
